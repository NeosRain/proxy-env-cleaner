# 代理环境清理工具 - 项目结构分析

## 项目概述

代理环境清理工具（Proxy Environment Cleaner）是一个跨平台的Python应用程序，旨在帮助用户检测和清理系统中的代理设置，包括系统代理、环境变量、Git配置等。同时，它还提供了镜像源管理功能，支持多种包管理器的镜像源切换。

## 项目结构

```
clash-env-cleaner/
├── .github/                    # GitHub相关配置
├── scripts/                    # 构建和部署脚本
├── src/                        # 源代码目录
│   ├── autostart/             # 开机自启功能模块
│   ├── core/                  # 核心功能模块
│   ├── gui/                   # 图形用户界面模块
│   ├── utils/                 # 工具函数模块
│   └── main.py               # 主入口文件
├── mirrors.json               # 镜像源配置文件
├── pyproject.toml             # 项目配置文件
├── requirements.txt           # 依赖包列表
├── README.md                  # 项目说明文件
├── CHANGELOG.md               # 更新日志
└── LICENSE                    # 许可证文件
```

## 详细文件分析

### 1. 根目录文件

#### `README.md`
项目说明文档，包含功能介绍、系统要求、安装使用方法、常见问题解答等。

#### `pyproject.toml`
项目配置文件，定义了项目的元数据、依赖包、构建配置等信息。

#### `requirements.txt`
列出项目所需的Python依赖包，包括PyQt6等GUI框架。

#### `mirrors.json`
镜像源配置文件，存储了各种镜像源的URL信息，包括APT、NPM、Pip、Yarn等包管理器的镜像源地址。

### 2. `src/` 源代码目录

#### `src/main.py` - 主入口文件
- **功能**: 程序的主入口点，负责初始化应用、设置开机自启、启动GUI界面
- **实现方式**: 
  - 导入Qt应用框架
  - 根据配置决定是否在启动时自动清理代理
  - 设置开机自启功能
  - 创建并显示主窗口
- **关键功能**:
  - 应用初始化
  - 自动清理功能
  - 开机自启设置

### 3. `src/autostart/` 开机自启模块

#### `src/autostart/autostart_windows.py` - Windows开机自启
- **功能**: 在Windows系统上设置/取消程序的开机自启
- **实现方式**: 通过修改注册表实现开机自启功能

#### `src/autostart/autostart_linux.py` - Linux开机自启
- **功能**: 在Linux系统上设置/取消程序的开机自启
- **实现方式**: 通过创建systemd服务或桌面文件实现开机自启功能

### 4. `src/core/` 核心功能模块

#### `src/core/detector.py` - 代理检测器
- **功能**: 检测系统中的各种代理设置
- **实现方式**: 
  - 跨平台检测系统代理设置
  - 检测环境变量中的代理配置
  - 检测Git、NPM、Pip等工具的代理配置
- **支持的检测项**:
  - 系统代理设置
  - 环境变量（HTTP_PROXY、HTTPS_PROXY等）
  - Git代理配置
  - NPM代理配置
  - Pip代理配置
  - APT代理配置

#### `src/core/cleaner_base.py` - 清理器基类
- **功能**: 定义清理器的基类和通用接口
- **实现方式**: 
  - 定义清理报告的数据结构
  - 提供通用的清理状态枚举
  - 定义清理器的抽象接口

#### `src/core/cleaner_windows.py` - Windows清理器
- **功能**: 专门处理Windows系统的代理清理
- **实现方式**:
  - 通过Windows API清理系统代理设置
  - 修改注册表中的代理配置
  - 清理环境变量
  - 处理UWP应用的回环代理设置
- **支持的清理项**:
  - Windows系统代理设置
  - 环境变量代理设置
  - Git代理配置
  - NPM/Pip/Yarn代理配置
  - UWP应用回环设置

#### `src/core/cleaner_linux.py` - Linux清理器
- **功能**: 专门处理Linux系统的代理清理
- **实现方式**:
  - 修改系统配置文件
  - 清理环境变量
  - 处理APT源配置
  - 处理各种包管理器配置
- **支持的清理项**:
  - 环境变量代理设置
  - Git代理配置
  - NPM/Pip/Yarn代理配置
  - APT源配置
  - Wget/Curl代理配置
  - Snap代理配置

#### `src/core/mirror_manager.py` - 镜像源管理器
- **功能**: 管理各种包管理器的镜像源配置
- **实现方式**:
  - 从本地配置文件读取镜像源信息
  - 提供镜像源切换功能
  - 支持配置备份和恢复
  - 提供镜像源测速功能
- **支持的镜像源**:
  - APT (Debian/Ubuntu软件源)
  - NPM (Node.js包管理器)
  - Pip (Python包管理器)
  - Yarn (JavaScript包管理器)
  - Snap (Linux软件包)
- **功能特性**:
  - 配置备份与恢复
  - 镜像源测速
  - 跨平台支持

### 5. `src/gui/` 图形用户界面模块

#### `src/gui/main_window.py` - 主窗口
- **功能**: 应用的主界面，提供代理清理和状态显示功能
- **实现方式**: 使用PyQt6框架创建GUI界面
- **界面组件**:
  - 环境状态检测显示区域
  - 清理选项复选框
  - 一键清理按钮
  - 清理后退出按钮
  - 镜像源管理按钮
  - 操作日志显示区域
  - 系统托盘集成
- **功能特性**:
  - 系统主题自适应
  - 详细的代理状态检测
  - 一键清理功能
  - 操作日志记录

#### `src/gui/mirror_dialog.py` - 镜像源设置对话框
- **功能**: 提供镜像源管理的专门界面
- **实现方式**: 使用PyQt6创建对话框界面
- **界面组件**:
  - 镜像源提供商选择
  - 镜像源配置预览
  - 配置应用按钮
  - 备份和恢复功能
- **功能特性**:
  - 镜像源预览
  - 配置应用确认
  - 配置备份管理

#### `src/gui/tray_icon.py` - 系统托盘图标
- **功能**: 在系统托盘中显示应用图标和菜单
- **实现方式**: 使用PyQt6的系统托盘功能
- **功能特性**:
  - 最小化到托盘
  - 托盘菜单
  - 消息通知

### 6. `src/utils/` 工具函数模块

#### `src/utils/config.py` - 配置管理
- **功能**: 管理应用配置和用户偏好设置
- **实现方式**: 使用JSON文件存储配置信息
- **配置项**:
  - 自动清理设置
  - 最小化到托盘设置
  - 各种清理选项的默认状态

#### `src/utils/logger.py` - 日志记录
- **功能**: 提供应用日志记录功能
- **实现方式**: 使用Python内置的logging模块
- **功能特性**:
  - 文件日志记录
  - 控制台日志输出
  - 日志级别管理

#### `src/utils/platform_utils.py` - 平台工具
- **功能**: 提供跨平台检测和操作工具
- **实现方式**: 根据操作系统返回相应的平台信息
- **功能**:
  - 平台检测（Windows/Linux）
  - 平台特定操作

#### `src/utils/subprocess_utils.py` - 子进程工具
- **功能**: 提供安全的子进程操作工具
- **实现方式**: 封装subprocess模块，提供安全的命令执行
- **功能特性**:
  - 安全的命令执行
  - 跨平台兼容性处理

### 7. `scripts/` 构建脚本目录

#### `scripts/build_windows.bat` - Windows构建脚本
- **功能**: 用于在Windows上构建可执行文件
- **实现方式**: 使用PyInstaller打包Python应用

#### `scripts/build_linux.sh` - Linux构建脚本
- **功能**: 用于在Linux上构建可执行文件
- **实现方式**: 使用PyInstaller打包Python应用

#### `scripts/cleanup.py` - 代码清理脚本
- **功能**: 用于清理项目中的冗余代码和文件
- **实现方式**: 自动检测和删除无用的代码段

## 核心功能实现方式

### 1. 代理检测机制
- **跨平台检测**: 根据不同操作系统使用相应的API和配置文件路径
- **多层检测**: 检测系统级、用户级、应用级的代理设置
- **智能识别**: 自动识别各种代理配置格式和位置

### 2. 代理清理机制
- **分层清理**: 按不同层次（系统、用户、应用）清理代理设置
- **安全清理**: 提供清理前的备份功能，避免误操作
- **状态报告**: 生成详细的清理报告，显示清理结果

### 3. 镜像源管理
- **配置管理**: 统一管理多种包管理器的镜像源配置
- **备份恢复**: 自动备份原始配置，支持一键恢复
- **测速功能**: 测试各镜像源的访问速度

### 4. 跨平台兼容性
- **条件导入**: 根据平台导入相应的模块
- **统一接口**: 提供统一的跨平台操作接口
- **平台特定处理**: 针对不同平台的特殊需求进行处理

## 创建的功能

### 1. 代理清理功能
- 系统代理清理
- 环境变量清理
- Git代理配置清理
- NPM/Pip/Yarn代理配置清理
- APT源配置清理

### 2. 镜像源管理功能
- APT镜像源切换（Debian/Ubuntu）
- NPM镜像源切换
- Pip镜像源切换
- Yarn镜像源切换
- Snap镜像源切换

### 3. 用户界面功能
- 中英文双语界面
- 系统托盘集成
- 详细的状态显示
- 操作日志记录
- 主题自适应

### 4. 高级功能
- 开机自启设置
- 自动清理功能
- 配置备份与恢复
- 镜像源测速
- 跨平台兼容

## 技术栈

- **编程语言**: Python 3.7+
- **GUI框架**: PyQt6
- **构建工具**: PyInstaller
- **CI/CD**: GitHub Actions
- **配置格式**: JSON

## 项目特点

1. **跨平台支持**: 同时支持Windows和Linux系统
2. **安全可靠**: 提供备份功能，避免误操作
3. **用户友好**: 提供直观的GUI界面和详细的操作日志
4. **功能丰富**: 不仅清理代理，还提供镜像源管理功能
5. **易于使用**: 一键清理，操作简单